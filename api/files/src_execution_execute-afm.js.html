---
layout: api
title: foobar
---
<div id="doc">
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <div id="api-tabview" class="tabview">
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul class="tabs">
                                <li><a href="#api-modules" class="category">Modules</a>
                                    <ul id="api-modules" class="apis modules">
                                        <li><a href="../modules/admin.html">admin</a></li>
                                        <li><a href="../modules/config.html">config</a></li>
                                        <li><a href="../modules/execution.html">execution</a></li>
                                        <li><a href="../modules/metadata.html">metadata</a></li>
                                        <li><a href="../modules/project.html">project</a></li>
                                        <li><a href="../modules/sdk.html">sdk</a></li>
                                        <li><a href="../modules/user.html">user</a></li>
                                        <li><a href="../modules/util.html">util</a></li>
                                        <li><a href="../modules/xhr.html">xhr</a></li>
                                    </ul>
                                </li>
                                <li><a href="#api-classes" class="category">Classes</a>
                                    <ul id="api-classes" class="apis classes">
                                        <li><a href="../classes/admin.html">admin</a></li>
                                        <li><a href="../classes/config.html">config</a></li>
                                        <li><a href="../classes/execution.html">execution</a></li>
                                        <li><a href="../classes/metadata.html">metadata</a></li>
                                        <li><a href="../classes/project.html">project</a></li>
                                        <li><a href="../classes/sdk.html">sdk</a></li>
                                        <li><a href="../classes/user.html">user</a></li>
                                        <li><a href="../classes/util.html">util</a></li>
                                        <li><a href="../classes/xhr.html">xhr</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <strong>gooddata-js</strong> <span class="version">v4.5.0</span>
                        <h1 class="file-heading">File: src/execution/execute-afm.js</h1>
                        
                        <div class="file">
                            <pre class="code prettyprint linenums">
                        // Copyright (C) 2007-2014, GoodData(R) Corporation. All rights reserved.
                        import { get, clone } from &#x27;lodash&#x27;;
                        import invariant from &#x27;invariant&#x27;;
                        import qs from &#x27;qs&#x27;;
                        import { ajax, post, parseJSON } from &#x27;../xhr&#x27;;
                        
                        const PAGE_SIZE = 500;
                        const DEFAULT_DIMENSION_COUNT = 2;
                        
                        function getDimensionality(execution) {
                            const dimensions = get(execution, &#x27;execution.resultSpec.dimensions&#x27;);
                            return dimensions
                                ? dimensions.length
                                : DEFAULT_DIMENSION_COUNT;
                        }
                        
                        function getLimit(offset) {
                            return Array(offset.length).fill(PAGE_SIZE);
                        }
                        
                        function fetchExecutionResult(pollingUri, offset) {
                            const [uriPart, queryPart] = pollingUri.split(/\?(.+)/);
                            const query = {
                                ...qs.parse(queryPart),
                                limit: getLimit(offset).join(&#x27;,&#x27;),
                                offset: offset.join(&#x27;,&#x27;)
                            };
                            const finalPollingUri = uriPart + qs.stringify(query, { addQueryPrefix: true });
                            return ajax(finalPollingUri, { method: &#x27;GET&#x27; }).then((r) =&gt; {
                                if (r.status === 204) {
                                    return null;
                                }
                                return r.json();
                            });
                        }
                        
                        // works only for one or two dimensions
                        export function mergePageData(result, currentPage) {
                            const { paging, data, headerItems } = currentPage.executionResult;
                            const rowOffset = paging.offset[0];
                            if (result.executionResult.data[rowOffset]) { // appending columns to existing rows
                                for (let i = 0; i &lt; data.length; i += 1) {
                                    result.executionResult.data[i + rowOffset].push(...data[i]);
                                }
                            } else { // appending new rows
                                result.executionResult.data.push(...data);
                            }
                        
                            const doDimension = (dim) =&gt; {
                                const otherDimension = (dim === 0 ? 1 : 0);
                                const isEdge = (paging.offset[otherDimension] === 0);
                                if (isEdge) {
                                    for (let attrIdx = 0; attrIdx &lt; headerItems[dim].length; attrIdx += 1) {
                                        result.executionResult.headerItems[dim][attrIdx].push(...headerItems[dim][attrIdx]);
                                    }
                                }
                            };
                        
                            // careful: for 1 dimension we already have the headers from first page
                            if (paging.offset.length &gt; 1) {
                                doDimension(0);
                                doDimension(1);
                            }
                        
                            return result;
                        }
                        
                        export function nextPageOffset({ offset, total }) {
                            const newOffset = clone(offset);
                            const maxDimension = offset.length - 1;
                            // we need last dimension first (aka columns, then rows) to allow array appending in merge fnc
                            for (let i = maxDimension; i &gt;= 0; i -= 1) {
                                if (newOffset[i] + PAGE_SIZE &lt; total[i]) {
                                    newOffset[i] += PAGE_SIZE;
                                    return newOffset;
                                }
                                newOffset[i] = 0;
                            }
                            return false;
                        }
                        
                        function getOnePage(pollingUri, offset, prevResult = null) {
                            return fetchExecutionResult(pollingUri, offset).then((executionResult) =&gt; {
                                if (executionResult === null) {
                                    return null;
                                }
                        
                                const newResult = prevResult ? mergePageData(prevResult, executionResult) : executionResult;
                        
                                const nextOffset = nextPageOffset(executionResult.executionResult.paging);
                                return nextOffset
                                    ? getOnePage(pollingUri, nextOffset, newResult)
                                    : newResult;
                            });
                        }
                        
                        /**
                         * Execute AFM and fetch data results
                         *
                         * @method executeAfm
                         * @param {String} projectId - GD project identifier
                         * @param {Object} execution - See https://github.com/gooddata/gooddata-typings/blob/master/index.ts#L4
                         *
                         * @return {Object} Structure with &#x60;executionResult&#x60; and &#x60;executionResponse&#x60; -
                         *  See https://github.com/gooddata/gooddata-typings/blob/master/index.ts#L294
                         */
                        export default function executeAfm(projectId, execution) {
                            const dimensionality = getDimensionality(execution);
                            invariant(dimensionality &lt;= 2, &#x27;executeAfm does not support more than 2 dimensions&#x27;);
                        
                            return post(&#x60;/gdc/app/projects/${projectId}/executeAfm&#x60;, { body: JSON.stringify(execution) })
                                .then(parseJSON)
                                .then((executionResponse) =&gt; {
                                    const offset = Array(dimensionality).fill(0); // offset holds information on dimensionality
                                    const pollingUri = executionResponse.executionResponse.links.executionResult;
                                    return getOnePage(pollingUri, offset).then((executionResult) =&gt; {
                                        return {
                                            executionResponse,
                                            executionResult
                                        };
                                    });
                                });
                        }
                        
                            </pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

